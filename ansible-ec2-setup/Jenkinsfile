pipeline {
    agent any

    parameters {
        string(name: 'CLIENT', defaultValue: 'ClientA', description: 'Client Name')
        string(name: 'CLIENT_IP', defaultValue: '54.159.128.24', description: 'EC2 Public IP for the client')
        string(name: 'ENVIRONMENT', defaultValue: 'dev', description: 'Environment')
    }

    stages {
        stage('Checkout Repository') {
            steps {
                echo "Checking out repository..."
                git branch: 'main', url: 'https://github.com/harshalpandit09/spring-jenkins-practice.git'
            }
        }

        stage('Prepare Inventory File') {
            steps {
                echo "Generating inventory.ini with CLIENT_IP=${params.CLIENT_IP}"
                sh '''
                cd ansible-ec2-setup
                echo "[ec2]" > inventory.ini
                echo "${CLIENT_IP} ansible_user=ec2-user ansible_ssh_private_key_file=~/.ssh/marketmap-key.pem" >> inventory.ini
                cat inventory.ini
                '''
            }
        }

        stage('Run Ansible Playbook') {
            steps {
                echo "Running Ansible Playbook for client=${params.CLIENT}, environment=${params.ENVIRONMENT}"
                sh '''
                cd ansible-ec2-setup
                wsl ansible-playbook -i inventory.ini setup-ec2.yml \
                    --extra-vars "client=${CLIENT} environment=${ENVIRONMENT}"
                '''
            }
        }
    }

    post {
        success {
            echo "Pipeline 3 completed successfully for client=${params.CLIENT} (${params.CLIENT_IP})"
        }
        failure {
            echo "Pipeline 3 failed! Check Ansible logs for details."
        }
    }
}