pipeline {
    agent { label 'Windows-WSL-Agent' }  // Use your WSL-enabled Jenkins agent

    parameters {
        string(name: 'CLIENT', defaultValue: 'ClientA', description: 'Client Name')
        string(name: 'CLIENT_IP', defaultValue: '3.92.210.163', description: 'EC2 Public IP for the client')
        string(name: 'ENVIRONMENT', defaultValue: 'dev', description: 'Environment (dev/staging/prod)')
    }

    stages {
        stage('Checkout Repository') {
            steps {
                echo "Checking out repository..."
                git branch: 'main', url: 'https://github.com/harshalpandit09/spring-jenkins-practice.git'
            }
        }

        stage('Prepare Inventory File') {
            steps {
                echo "Generating inventory.ini with CLIENT_IP=${params.CLIENT_IP}"
                bat """
                wsl -d Ubuntu-22.04 sh -c "cd ansible-ec2-setup && \
                echo '[ec2]' > inventory.ini && \
                echo '${params.CLIENT_IP} ansible_user=ec2-user ansible_ssh_private_key_file=~/.ssh/marketmap-key.pem' >> inventory.ini && \
                cat inventory.ini"
                """
            }
        }

        stage('Run Ansible Playbook') {
            steps {
                echo "Running Ansible playbook..."
                bat """
                wsl -d Ubuntu-22.04 sh -c "cd ansible-ec2-setup && \
                ansible-playbook -i inventory.ini setup-ec2.yml --extra-vars 'client=${params.CLIENT} environment=${params.ENVIRONMENT}'"
                """
            }
        }
    }

    post {
        success {
            echo "Pipeline 3 completed successfully for client=${params.CLIENT} (${params.CLIENT_IP})"
        }
        failure {
            echo "Pipeline 3 failed! Check Ansible logs for details."
        }
    }
}